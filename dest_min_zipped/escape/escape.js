function SfxrParams(){this.setSettings=function(t){for(var e=0;24>e;e++)this[e]=t[e]||0;this[2]<.01&&(this[2]=.01);var i=this[1]+this[2]+this[4];if(.18>i){var s=.18/i;this[1]*=s,this[2]*=s,this[4]*=s}}}function SfxrSynth(){this._params=new SfxrParams;var t,e,i,s,a,r,n,o,l,h,c,u;this.reset=function(){var t=this._params;s=100/(t[5]*t[5]+.001),a=100/(t[6]*t[6]+.001),r=1-t[7]*t[7]*t[7]*.01,n=-t[8]*t[8]*t[8]*1e-6,t[0]||(c=.5-t[13]/2,u=5e-5*-t[14]),o=1+t[11]*t[11]*(t[11]>0?-.9:10),l=0,h=1==t[12]?0:(1-t[12])*(1-t[12])*2e4+32},this.totalReset=function(){this.reset();var s=this._params;return t=s[1]*s[1]*1e5,e=s[2]*s[2]*1e5,i=s[4]*s[4]*1e5+12,3*((t+e+i)/3|0)},this.synthWave=function(f,d){var m=this._params,x=1!=m[18]||m[21],v=m[21]*m[21]*.1,y=1+3e-4*m[22],p=m[18]*m[18]*m[18]*.1,S=1+1e-4*m[19],g=1!=m[18],w=m[23]*m[23],T=m[6],b=m[16]||m[17],k=m[17]*m[17]*m[17]*.2,W=m[16]*m[16]*(m[16]<0?-1020:1020),P=m[15]?((1-m[15])*(1-m[15])*2e4|0)+32:0,H=m[3],I=m[9]/2,R=m[10]*m[10]*.01,C=m[0],M=t,A=1/t,D=1/e,F=1/i,L=5/(1+m[20]*m[20]*20)*(.01+p);L>.8&&(L=.8),L=1-L;var E,B,G,j,O,_,Y=!1,U=0,N=0,X=0,z=0,q=0,V=0,Z=0,K=0,J=0,Q=0,$=0,tt=new Array(1024),et=new Array(32);for($=tt.length;$--;)tt[$]=0;for($=et.length;$--;)et[$]=2*Math.random()-1;for($=0;d>$;$++){if(Y)return $;switch(P&&++J>=P&&(J=0,this.reset()),h&&++l>=h&&(h=0,s*=o),r+=n,s*=r,s>a&&(s=a,T>0&&(Y=!0)),B=s,I>0&&(Q+=R,B*=1+Math.sin(Q)*I),B|=0,8>B&&(B=8),C||(c=clamp(c+u,0,.5)),++N>M&&(N=0,U++,M=1==U?e:2==U?i:-1),U){case 0:X=N*A;break;case 1:X=1+2*(1-N*D)*H;break;case 2:X=1-N*F;break;case 3:X=0,Y=!0}b&&(W+=k,G=0|W,0>G?G=-G:G>1023&&(G=1023)),x&&y&&(v=clamp(v*y,1e-5,.1)),_=0;for(var it=8;it--;){if(Z++,Z>=B&&(Z%=B,3==C))for(var st=et.length;st--;)et[st]=2*Math.random()-1;switch(C){case 0:O=c>Z/B?.5:-.5;break;case 1:O=1-Z/B*2;break;case 2:j=Z/B,j=6.28318531*(j>.5?j-1:j),O=1.27323954*j+.405284735*j*j*(0>j?1:-1),O=.225*((0>O?-1:1)*O*O-O)+O;break;case 3:O=et[Math.abs(32*Z/B|0)]}x&&(E=V,p=clamp(p*S,0,.1),g?(q+=(O-V)*p,q*=L):(V=O,q=0),V+=q,z+=V-E,z*=1-v,O=z),b&&(tt[K%1024]=O,O+=tt[(K-G+1024)%1024],K++),_+=O}_*=.125*X*w,f[$]=_>=1?1:-1>=_?-1:_}return d}}function isMobile(){var t=/iphone|ipod|ipad|android|ie|blackberry|fennec|mobile/i;return navigator.userAgent.toLowerCase().match(t)}function clamp(t,e,i){return e>t?e:t>i?i:t}function sq(t){return t*t}function sinOsc(t,e,i){return i=i||Date.now,t*Math.sin(.06*e*i())}function osc(t,e,i,s){s=s||Date.now;var a=(e-t)/2;return t+a*(1+Math.sin(.06*i*s()))}function dirac(t,e,i,s,a,r){a=a||Date.now,r=r||0;var n=(a()-r)%s;return i>n?e:t}function clearInputs(){for(var t in keys)InputState[keys[t]]=!1}function setupKeys(){window.addEventListener("keydown",function(t){var e=t.keyCode||t.which;InputState[e]=!0,t.stopPropagation(),t.preventDefault()},!1),window.addEventListener("keyup",function(t){var e=t.keyCode||t.which;InputState[e]=!1},!1)}function setupTouches(){function t(t,e){cv.addEventListener(t,e)}function e(t){for(var e=0;10>e;e++){var i=f[e];if(i.id==t)return i}return null}function i(t){t.stopPropagation(),t.preventDefault()}function s(t){for(var i=t.changedTouches,s=0;s<i.length;s++){var a=i[s],r=e(a.identifier);null!=r&&(r.id=-1,d--)}}function a(t){if(0==d)return null;for(var e=0;e<f.length;e++){var i=f[e];if(i.id>=0&&t.pointInside(i.pos.x,i.pos.y))return i}return null}window.ontouchmove=function(t){t.preventDefault()},window.ontouchstart=function(t){t.preventDefault()},System.screenAsButton=new TouchButton("SPACE",0,0,W,H,!0,!0);var r=System.buttons=[],n=.03*W,o=.03*H,l=.18*W,h=.16*H,c=1,u=H-o-h;r.push(new TouchButton("LEFT",n,u,l,h)),r.push(new TouchButton("RIGHT",l+2*n,u,l,h)),r.push(new TouchButton("UP",W-2*l-n,u,l,h)),r.push(new TouchButton("SPACE",W-l-n,u-o-h,l,h,!0)),r.draw=function(){r.forEach(function(t){t.draw()})},r.update=function(){r.forEach(function(t){t.update()})};for(var f=System.touches=[],d=0,m=0;10>m;m++)f.push(new TouchInfo);t("touchstart",function(t){i(t);for(var s=t.changedTouches,a=0;a<s.length;a++){var r=s[a],n=e(-1);null!=n&&(c++,n.pos.x=(r.clientX-cvRect.left)/ratio,n.pos.y=(r.clientY-cvRect.top)/ratio,n.id=r.identifier,n.uid=c,d++)}}),t("touchmove",function(t){i(t);for(var s=t.changedTouches,a=0;a<s.length;a++){var r=s[a],n=e(r.identifier);null!=n&&(n.pos.x=(r.clientX-cvRect.left)/ratio,n.pos.y=(r.clientY-cvRect.top)/ratio,d--)}}),t("touchend",s),t("touchcancel",s),f.oneTouchInsideRect=a}function TouchInfo(){this.id=-1,this.pos={x:0,y:0}}function TouchButton(t,e,i,s,a,r,n){this.name=t,BBox.call(this,e,i,s,a),this.id=-1,this.uid=-1,this.switchId=-1,this.once=r||!1,this.draw=function(){if(!n){ctx.save(),ctx.fillStyle="#F5F",ctx.globalAlpha=.3,roundRect(ctx,this.x,this.y,this.w,this.h,.12*this.w),ctx.lineWidth=2,ctx.fill(),ctx.globalAlpha=.2,ctx.strokeStyle="#F5F",ctx.stroke(),ctx.globalAlpha=.8;var e=null;if("LEFT"==t&&(e=Math.PI),"RIGHT"==t&&(e=0),"UP"==t&&(e=-Math.PI/2),null!=e)drawArrow(this.x+.2*s,i+.2*a,.6*s,.6*a,e,"#A96");else{var r=Math.min(this.w,this.h),o=.3*r,l=.3*r;ctx.lineWidth=o,ctx.globalAlpha=.7,ctx.beginPath(),ctx.strokeStyle="hsl(246, 80%, 70%)",ctx.arc(this.x+(this.w>>1),this.y+(this.h>>1),l,0,Math.PI),ctx.stroke(),ctx.beginPath(),ctx.strokeStyle="hsl(359, 80%, 70%)",ctx.arc(this.x+(this.w>>1),this.y+(this.h>>1),l,Math.PI,2*Math.PI),ctx.stroke()}ctx.restore()}},this.update=function(){var t=InputState[keys[this.name]],e=System.touches.oneTouchInsideRect(this),i=!1;this.once?!t&&e&&this.switchId!=e.uid&&(this.switchId=e.uid,i=!0):i=e,InputState[keys[this.name]]=i}}function drawArrow(t,e,i,s,a,r,n,o){var l=i/8;ctx.save(),ctx.lineJoin="round",ctx.beginPath(),ctx.translate(t+i/2,e+s/2),ctx.rotate(a),ctx.translate(-i/2,-s/2),ctx.moveTo(2*i/3,.8*s),ctx.lineTo(i,s/2),ctx.lineTo(2*i/3,.2*s),ctx.lineTo(2*i/3,s/2-l),ctx.lineTo(0,s/2-l),ctx.lineTo(0,s/2+l),ctx.lineTo(2*i/3,s/2+l),ctx.closePath(),r&&(ctx.fillStyle=r,ctx.fill()),n&&(ctx.strokeStyle=n,ctx.lineWidth=o||4,ctx.stroke()),ctx.restore()}function BBox(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s,this.overlaps=function(t){return!(this.x>t.x+t.w||this.x+this.w<t.x||this.y>t.y+t.h||this.y+this.h<t.y)},this.pointInside=function(t,e){return gravityDirection>0?t>=this.x&&t<this.x+this.w&&e>=this.y&&e<this.y+this.h:t>this.x&&t<=this.x+this.w&&e>this.y&&e<=this.y+this.h},this.vSegmentIntersect=function(t,e,i){if(t<this.x||t>=this.x+this.w)return!1;if(i>=this.y&&i<this.y+this.h)return!0;var s=this.y;return e>i&&(s+=this.h),0>=(s-e)*(s-i)}}function Building(t,e,i,s,a){function r(t,e,i,s,a){var r=(17159*t+a)%569,n=(16339*t+a)%677,o=(34963*t+a)%2969,c=4+r%5,u=3+n%12;ctx.fillStyle=(r+n)%2?l:h,ctx.save(),ctx.translate(t*e,s-i*u/14),ctx.scale(e*c/6,i*u/14),ctx.fillRect(0,0,1,1);var f=4200+o%6e3,d=0|Date.now()/f,m=(7717*t+a+33641*d)%5791;ctx.fillStyle="#777700";for(var x=0|m/5791*(.2*c*u),v=0;x>v;v++){var y=.2/c,p=.15/u,S=(m+34217*v%1321)%c,g=(m+35141*v%1873)%u;ctx.fillRect(S/c+y,g/u+p,1/c-2*y,1/u-2*p)}ctx.restore()}function n(){ctx.fillStyle=u,ctx.fillRect(0,c,W,H-c)}var o="#333",l="#433",h="#334",c=t+i-1,u=createGradient([0,c,0,H],[0,o,1,"#000"]);t+=i,this.draw=function(o){var l=0|s/e,h=0|o/e;ctx.save(),ctx.translate(-o,t);for(var c=h-1;h+l+1>=c;c++)r(c,e,i,0,a);ctx.restore(),n()}}function createCanvas(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i}function buildShadow(t,e){var i=createCanvas(t.width,t.height),s=i.getContext("2d");return s.save(),s.fillStyle=e,s.fillRect(0,0,i.width,i.height),s.globalCompositeOperation="destination-in",s.drawImage(t,0,0),s.restore(),i}function buildImageData(t){var e=createCanvas(t.width,t.height),i=e.getContext("2d");return i.drawImage(t,0,0),i.getImageData(0,0,t.width,t.height)}function turnRedToBlue(t){var e=buildImageData(t),i=e.data;i[50]=10;for(var s=0;s<i.length-100;s+=4)i[s+2]>250&&(i[s]=255,i[s+1]=0,i[s+2]=0,i[s+2]=0);e.data=i;var a=createCanvas(t.width,t.height);return a.getContext("2d").putImageData(e,0,0),a}function setupStandardGradient(){gradients={0:createPlatformGradient(hueColors[0]),1:createPlatformGradient(hueColors[1]),o0:createGradient([0,0,1,0],[0,"#844",.5,"#F88",1,"#844"]),o1:"#9F8",str:"#242",bg:createGradient([0,1,0,0],[0,hsl(195,100,10),1,hsl(195,100,40)])}}function drawImage(t,e,i,s,a,r,n,o,l,h){h=h||0;var c=0;h&&(c+=s*h),ctx.save(),ctx.translate(e,i),o&&(ctx.translate(r,0),ctx.scale(-1,1)),l&&(ctx.translate(0,n),ctx.scale(1,-1)),ctx.drawImage(t,c,0,s,a,0,0,r,n),ctx.restore()}function glowText(t,e,i,s,a){sft(s);var r=1e3,n=6;ctx.save(),ctx.fillStyle="#FFF",ctx.globalAlpha=.9,ctx.shadowColor=hsl(235,85,95),ctx.shadowBlur=24,ctx.shadowOffsetX=scale*(r-4-2*Math.random()),ctx.shadowOffsetY=scale*(-4+Math.random()),ctx.fillText(t,e-r,i),ctx.fillText(t,e-r,i),ctx.shadowColor=hsl(350,75,85),ctx.shadowBlur=14,ctx.shadowOffsetX=scale*(r+n+2*Math.random()),ctx.shadowOffsetY=scale*(n+Math.random()),ctx.fillText(t,e-r,i),ctx.fillText(t,e-r,i),ctx.globalAlpha=1,ctx.shadowColor=null,ctx.fillStyle=a,ctx.fillText(t,e,i),ctx.restore()}function createPlatformGradient(t){var e=document.createElement("canvas");e.width=e.height=64;var i=e.getContext("2d"),s=.15,a=hsl(t,65,40),r=hsl(t,75,45),n=hsl(t,90,65),o=hsl(t,100,80),l=createGradient([0,0,64,64],[0,a,.25-s-.01,r,.25-s,n,.25,o,.25+s,n,.25+s+.01,r,.5,a,.75-s-.01,r,.75-s,n,.75,o,.75+s,n,.75+s+.01,a,1,a]);return i.fillStyle=l,i.fillRect(0,0,64,64),ctx.createPattern(e,"repeat")}function hsl(t,e,i){return"hsl("+t+","+e+"%,"+i+"%)"}function roundRect(t,e,i,s,a,r){return 2*r>s&&(r=s/2),2*r>a&&(r=a/2),t.beginPath(),t.moveTo(e+r,i),t.arcTo(e+s,i,e+s,i+a,r),t.arcTo(e+s,i+a,e,i+a,r),t.arcTo(e,i+a,e,i,r),t.arcTo(e,i,e+s,i,r),t.closePath(),t}function sft(t){ctx.font=t+"px Futura, Helvetica, sans-serif"}function erase(){ctx.fillStyle="#000",ctx.fillRect(0,0,W,H)}function fillBG(){ctx.save(),ctx.fillStyle=gradients.bg,ctx.scale(W,.55*H),ctx.fillRect(0,0,1,1),ctx.restore()}function createGradient(t,e){for(var i=ctx.createLinearGradient.apply(ctx,t),s=0;s<e.length;s+=2)i.addColorStop(e[s],e[s+1]);return i}function createZeroRadialGradients(t,e,i){var s=[0,"#000",0,e,1,"#000"];return createRadialGradients(t,s,i)}function createRadialGradients(t,e,i){for(var s=[],a=1/(i+1),r=1;i>=r;r++)e[2]=a*r,s.push(createRadialGradient(t,e));return s}function createRadialGradient(t,e){3==t.length&&(t=[t[0],t[1],t[2]],t.push(t[0],t[1],t[2]),t[2]=0);for(var i=ctx.createRadialGradient.apply(ctx,t),s=0;s<e.length;s+=2)i.addColorStop(e[s],e[s+1]);return i}function decodeLevel(t,e){function i(t,e){var i=(e-1)*h+t<<2;return n(u,i)?-1:1}function s(t,e){var i=1,s=(e.y-1)*h+e.x<<2;n(u,s)&&(i*=-1),t.triggers.push(new Trigger(["flip",e.x,e.y,1,1,i]))}function a(t,e,i){var s=0;do i+=4,s++;while(i<t.length&&n(t,i)==e);return s}function r(t,e,i,s){var a=0;do o(t,e,s),s+=4*h,a++;while(s<t.length&&n(t,s)==i);return a}function n(t,e){return(t[e]>192?4:0)+(t[e+1]>192?2:0)+(t[e+2]>192?1:0)}function o(t,e,i){for(var s=i+4*e;s>i;i+=4)l(t,i)}function l(t,e){t[e]=t[e+1]=t[e+2]=0}var h=e.width,c=buildImageData(e).data,u=buildImageData(e).data;t.platforms=[];var f=0;for(f=28;f<c.length;f+=4){var d=n(c,f);if(d)if(7>d){var m=a(c,d,f),x=r(c,m,d,f),v=f>>2,y=v%h,p=(v-y)/h;if(5>d){var S=d>=3,g=d-1&1;t.platforms.push([y,p,m,x,g,+S*t.platformPeriod])}else 5==d&&t.triggers.push(new Trigger(["end",y,p,m,x,i(y,p)]))}else 7==d&&s(t,{x:(f>>2)%h,y:0|(f>>2)/h})}t.dataLoaded=!0}function Camera(t,e,i,s){BBox.call(this,t,e,i,s),this.scale=1,this.reset=function(){this.x=this.y=0,this.w=W,this.h=H},this.adjust=function(t,e){var i=this.x,s=this.y,a=t.x+t.w/2,r=(t.y+t.h/2,i+t.vx*e),n=s,o=r,l=.3,h=a-i,c=.3,u=.7,f=.08;c*W>h?r+=f*(h-c*W):h>u*W&&(r+=f*(h-u*W)),Math.abs(t.vx)>.1&&(t.vx>0?u=.35:c=.65,c*W>h?o+=f*(h-c*W):h>u*W&&(o+=f*(h-u*W)),r=(1-l)*r+l*o);var d=t.y-s,m=.45,x=.5,v=.02;m*H>d?n+=v*(d-m*H):d>x*H&&(n+=v*(d-x*H)),r=clamp(r,-camXMargin,playScreen.worldW+camXMargin),n=clamp(n,-camYMargin,playScreen.worldH+camYMargin),this.x=0|r,this.y=0|n}}function Hero(t,e,i,s){function a(t,e){return gravityDirection>0?t<=e.y+.05:t>=e.y+e.h-.05}BBox.call(this,t,e,i,s),this.vx=0,this.vy=0,this.thrust=0,this.jumping=!1,this.jumpTime=0,this.platform=null,this.unfalling=0,this.lastPos={platform:null,x:0,y:0,lastGravityDirection:1},this.color=0,this.life=100,this.losingLife=0,this.images=[RSC.heroSpriteImg2,RSC.heroSpriteImg],this.shadowImage=buildShadow(this.images[0],"#FFF"),this.owner=null;var r=10,n=createZeroRadialGradients([0,0,1],colors[0],r),o=createZeroRadialGradients([0,0,1],colors[1],r),l=[n,o];skateSound||(skateSound=buildLoopBuffer(SOUNDS.noise)),this.reset=function(){this.vx=0,this.vy=0,this.jumping=!1,this.platform=null,this.thrust=0,this.life=100,this.losingLife=0,this.color=0,gravityDirection=1},this.draw=function(){var t=!1;if(this.losingLife||this.unfalling){var e=this.losingLife||this.unfalling;Math.floor((Date.now()-e)/200)%2||(t=!0)}var i=this.vx<0,s=0>gravityDirection,a=0;!this.platform&&Math.abs(this.vx)>.01&&(a=this.vy*gravityDirection<0?1:2),drawImage(this.images[this.color],this.x,this.y,heroSpriteWidth,heroSpriteHeight,heroWidth,heroHeight,i,s,a),t&&(ctx.save(),ctx.globalAlpha*=.7,drawImage(this.shadowImage,this.x,this.y,heroSpriteWidth,heroSpriteHeight,heroWidth,heroHeight,i,s,a),ctx.restore())},this.drawColor=function(){var t=0|r*osc(0,1,.05,System.sysNow),e=l[this.color][t];ctx.save(),ctx.globalAlpha*=osc(.3,.7,.237),ctx.globalCompositeOperation="lighter",ctx.translate(this.x+this.w/2,this.y+this.h/2),ctx.scale(1.4*this.h,1.4*this.h),ctx.beginPath(),ctx.fillStyle=e,ctx.arc(0,0,1,0,2*Math.PI),ctx.fill(),ctx.restore()},this.save=function(){this.lastPos.platform=this.platform,this.lastPos.x=this.x,this.lastPos.y=this.y,this.lastPos.lastGravityDirection=gravityDirection},this.restore=function(){this.platform=this.lastPos.platform,this.x=this.lastPos.x,this.y=this.lastPos.y,gravityDirection=this.lastPos.lastGravityDirection,this.jumping=!1},this.standStill=function(){this.vx=this.vy=this.thrust=0},this.update=function(t){skateSound.gain.value=this.jumping?0:Math.abs(this.vx)>.05?2*Math.abs(this.vx):0;var e=null;this.platform&&this.platform.color!=this.color?(this.life-=lifeLooseSpeed*t,this.losingLife||(this.losingLife=Date.now()),this.life<0&&(this.life=0,messageScreen.launch("Game Over - No more energy-","Score : "+playScreen.score,2e3,function(){System.launchScreen(titleScreen)}))):this.losingLife=0,this.platform&&this.save(),this.vx+=this.thrust*t-this.vx*friction,null==this.platform?this.vy=clamp(this.vy+gravityDirection*gravity*t,-maxVSpeed,maxVSpeed):this.vy=0;var i=this.vx,s=this.vy;e=this.platform,this.x+=i*t;var r=this.y,n=s*t,o=this.x+this.w*(.5-.4),l=this.x+.9*this.w,h=r;if(1==gravityDirection&&(h+=this.h),e){if(!(o>e.x+e.w&&l>e.x+e.w||o<e.x&&l<e.x))return void this.adjustOnPlatform(e);this.platform=null}if(gravityDirection*this.vy<0)return void(this.y+=n);for(var c=this.owner.platforms,u=0;u<c.length;u++)if(e=c[u],(e.vSegmentIntersect(o,h,h+n)||e.vSegmentIntersect(l,h,h+n))&&a(h,e))return this.platform=e,this.jumping=!1,this.save(),this.adjustOnPlatform(e),void playSound(SOUNDS.landed,0,12);this.y+=n},this.adjustOnPlatform=function(t){1==gravityDirection?this.y=t.y-this.h:this.y=t.y+t.h},this.flip=function(){this.vy=-2*gravityDirection*vPunch,this.platform=null},this.jump=function(t){void 0===t&&(t=!0),this.platform=null,this.jumping=!0,this.jumpTime=System.systemTime,this.vy=-gravityDirection*vPunch,t&&playSound(SOUNDS.jump,0,4)},this.handleInput=function(){var t=320;InputState[keys.UP]||InputState[keys.UP2]?null!=this.platform&&this.jump():this.jumping&&this.jumpTime&&System.systemTime-this.jumpTime<t&&(this.jumpTime=0,this.vy/=4),InputState[keys.LEFT]?this.thrust=-maxThrust:InputState[keys.RIGHT]?this.thrust=maxThrust:this.thrust=0,InputState[keys.SPACE]&&(this.color=1-this.color,InputState[keys.SPACE]=!1)}}function Mountain(t,e,i,s){function a(t,e,i){var s=t/2;return e/=s,i=i||0,i+=t,function(a){return a+=i,a%=t,a>s&&(a=t-a),0|a*e}}this.mountainGradient=createGradient([0,0,0,e],[0,"#FFF",.12,"#EEE",.26,"#DDD",.4,"#BBB",1,"#555"]),this.endGradient=createGradient([0,e,0,s-t],[0,"#555",1,"#000"]),this.baseY=t,this.amplitude=e,e/=2.14;var r=a(i,e,280),n=a(.52341247*i,.8*e,230),o=a(.133479532*i,.14*e,10),l=a(.174797531*i,.12*e,10,15);this.mountainFunction=function(t){return r(t)+n(t)+o(t)+l(t)},this.draw=function(e,i){e=0|(e||0),i=0|(i||0);var a=30,r=this.mountainFunction,n=30,o=-a,l=e%n,h=e-l;for(ctx.save(),ctx.translate(-l-a,this.baseY+i),ctx.beginPath(),ctx.moveTo(0,r(h+o));W+2*n>o;o+=n)ctx.lineTo(o,r(o+h));ctx.lineTo(o,this.amplitude),ctx.lineTo(0,this.amplitude),ctx.closePath(),ctx.lineWidth=2,ctx.strokeStyle="#000",ctx.fillStyle=this.mountainGradient,ctx.stroke(),ctx.fill(),ctx.fillStyle=this.endGradient,ctx.fillRect(0,this.amplitude-1,W+2*n-1,s-t+1),ctx.restore()}}function Platform(t,e,i,s,a,r){BBox.call(this,t*blockWidth,e*blockHeight,i*blockWidth,s*blockHeight),this.color=a,this.period=r,this.colorSwitchTime=-1e3,baseHue=0==a?259:346;var n=500,o=250,l=50;return this.draw=function(){ctx.save(),ctx.globalAlpha*=platformAlpha,ctx.translate(this.x,this.y);var t=gradients[this.color];ctx.fillStyle=t,ctx.fillRect(0,0,this.w,this.h),ctx.restore(),ctx.strokeStyle=gradients.str;var e=1.5,i=!1,s=!1;this.period&&(i=System.systemTime-this.colorSwitchTime>=this.period-n,i&&(s=dirac(0,1,l,o,System.sysNow,this.colorSwitchTime)>.5,s&&System.systemTime-playingSound>2*n&&(playingSound=System.systemTime,playSound(SOUNDS.blip),playSound(SOUNDS.blip,0,0,o/1e3)))),drawPlatformOutline(this.x+e,this.y+e,this.w-2*e,this.h-2*e,e,s)},this.update=function(t){this.period&&this.period&&System.systemTime-this.colorSwitchTime>this.period&&(this.color=1-this.color,this.colorSwitchTime=System.systemTime)},this}function drawPlatformOutline(t,e,i,s,a,r){var n=5*a/2;if(r)return ctx.strokeStyle="#EEE",ctx.lineWidth=n,void ctx.strokeRect(t,e,i,s);ctx.strokeStyle="#666",ctx.lineWidth=n,ctx.strokeRect(t,e,i,s);var o=a;ctx.strokeStyle="#999",ctx.lineWidth=o;var l=a/2;ctx.strokeStyle="#CCC",ctx.lineWidth=l,ctx.beginPath(),ctx.moveTo(t-l,e-l),ctx.lineTo(t-l+i+n,e-l),ctx.moveTo(t-l,e-l),ctx.lineTo(t-l,e-l+s),ctx.stroke(),ctx.strokeStyle="#444",ctx.beginPath(),ctx.moveTo(t-l,e-l+s),ctx.lineTo(t-l+i+n,e-l+s),ctx.lineTo(t-l+i+n,e-l),ctx.stroke()}function Star(t,e,i){10*Math.random();this.draw=function(){ctx.globalAlpha=.5+osc(0,.5,.2),ctx.fillStyle="#FF4",ctx.fillRect(t,e,i,i)}}function drawStars(t){ctx.save(),t.forEach(function(t){t.draw()}),ctx.restore()}function buildStars(t,e,i,s,a){for(var r=[],n=0;t>n;n++){var o=new Star(e*Math.random(),i*Math.random(),s+(a-s)*Math.random());r.push(o)}return r}function Trigger(t){BBox.call(this,t[1]*blockWidth,t[2]*blockHeight,t[3]*blockWidth,t[4]*blockHeight);var e=t[0];if("msg"==e)this.txt=t[5],this.size=t[6],this.duration=t[7],this.draw=function(){};else if("end"==e)this.direction=t[5],this.draw=function(){ctx.save(),ctx.globalAlpha*=.4+osc(0,.7,.006),ctx.fillStyle="#9F9",ctx.fillRect(this.x,this.y,this.w,this.h),ctx.restore(),dirac(0,1,700,800)>.5&&(sft(26),ctx.fillStyle="#000",ctx.fillText("EXIT",this.x+this.w/2,this.y+this.h/2))},this.update=function(){var t=this.overlaps(playScreen.hero);if(t){playScreen.currentLevel++;var e="Level Score : "+playScreen.levelScore()+"   Score : "+(playScreen.score+playScreen.levelScore());playScreen.currentLevel==levels.length?(messageScreen.launch("You escaped !! Congratulations !!",e,1500,function(){System.launchScreen(titleScreen)}),playScreen.updateScore()):(messageScreen.launch("You escaped from level "+playScreen.currentLevel,e,1500,function(){System.launchScreen(playScreen)}),playScreen.updateScore())}};else if("flip"==e){var i=this.x,s=this.y,a=this.w,r=this.h;BBox.call(this,this.x+this.w/2.5,this.y,this.w/5,this.h);var n=-1e3,o=t[5],l=1==t[5]?-Math.PI/2:Math.PI/2;this.draw=function(){var t=.1*a,e=t*Math.sin(.006*Date.now());drawArrow(i+.05*a,s+e-t*o,.55*a,r,l,null,"#F66",3),drawArrow(i+.5*a,s+e-t*o,.55*a,r,l,null,"#F66",3)},this.update=function(){System.systemTime-n<1200||this.overlaps(playScreen.hero)&&(playScreen.hero.flip(),n=System.systemTime,gravityDirection*=-1,playSound(SOUNDS.reversing))}}}function main(){RSC.heroSpriteImg2=turnRedToBlue(RSC.heroSpriteImg),debug?(playScreen.currentLevel=startLevel,System.boot(playScreen)):System.boot(titleScreen),ctx.scale(scale,scale)}var synth=new SfxrSynth;window.jsfxr=function(t){var e=window.AudioContext||window.webkitAudioContext;window._audioContext=window._audioContext||new e;var i=window._audioContext;synth._params.setSettings(t);var s=synth.totalReset(),a=s+1>>1<<1,r=i.createBuffer(1,a,i.sampleRate),n=r.getChannelData(0);return 2*synth.synthWave(n,s),r},window.playSound=function(t,e,i,s){if(System.currentScreen==playScreen){var a="Array"==typeof t?jsfxr(t):t,r=window._audioContext,n=r.createBufferSource();n.buffer=a,n.loop=!1,e=e||0,i=i||0,s=s||0,i&&(i*=Math.random()-.5),n.detune&&(n.detune.value=100*(e+i)),n.connect(r.destination),n.start(r.currentTime+s)}},window.buildLoopBuffer=function(t){var e="Array"==typeof t?jsfxr(t):t,i=window._audioContext,s=i.createBufferSource(),a=i.createGain();return s.buffer=e,s.loop=!0,s.loopStart=.4,s.loopEnd=1.2,a.connect(i.destination),s.connect(a),s.start(i.currentTime),a},function(){function t(){i--,i||e()}function e(){main()}var i=1;window.addRsc=function(e,s){var a=new e;return i++,a.addEventListener("load",t),a.src=s,a},window.addEventListener("load",t)}();var System={currentScreen:null,touches:null,buttons:null,screenAsButton:null,systemTime:0,isMobile:!1,_lastTime:0,boot:function(t){function e(t){var e=canvasWidth/canvasHeight,i=window.innerWidth,s=window.innerHeight,a=i*(i/e),r=s*(s*e);if(a>r){var n=Math.min(i,Math.floor(s*e));cv.style.width=n+"px",cv.style.height=Math.floor(n/e)+"px",ratio=n/W}else{var o=Math.min(s,Math.floor(i/e));cv.style.width=Math.floor(o*e)+"px",cv.style.height=o+"px",ratio=o/H}cvRect=cv.getBoundingClientRect()}cv=document.getElementById("cv"),cv.width=W=canvasWidth,cv.height=H=canvasHeight,W/=scale,H/=scale,cvRect=cv.getBoundingClientRect(),ctx=cv.getContext("2d"),ctx.textAlign="center",ctx.textBaseline="middle";var i=localStorage.hiScore;+i!=i&&(localStorage.hiScore=0),e(),window.onresize=e,window.ondeviceorientation=e,setupStandardGradient(),this.isMobile=isMobile(),this.isMobile?(timeSpeed=.8,setupTouches()):(setupKeys(),showTouch?setupTouches():this.touches=null),this.launchScreen(t),this.launchAnimation()},launchScreen:function(t){this.currentScreen=t,t.launch()},launchAnimation:function(){requestAnimationFrame(this._launchAnimation.bind(this))},_launchAnimation:function(t){this._lastTime=t,this.currentScreen.launch(),this._boundAnimate=this._animate.bind(this),requestAnimationFrame(this._boundAnimate)},_boundAnimate:null,_animate:function(t){requestAnimationFrame(this._boundAnimate);var e=t-this._lastTime;e>50&&(e=16),this._lastTime=t,e*=timeSpeed,this.systemTime+=e;var i=this.currentScreen==playScreen?this.buttons:this.screenAsButton;i&&i.update(),this.currentScreen.update(e),this.currentScreen.draw(),i&&i.draw&&i.draw()},sysNow:function(){return System.systemTime}},cv=null,ctx=null,cvRect=null,W=0,H=0,ratio=1,debug=!1,showTouch=!1,startLevel=1,gradients={},ratio=4/3,canvasWidth=640,canvasHeight=0|canvasWidth/ratio,scale=.85,blockWidth=72,blockHeight=40,camXMargin=40,camYMargin=100,heroWidth=40,heroHeight=60,heroSpriteWidth=32,heroSpriteHeight=32,gravity=.0025,gravityDirection=1,vPunch=.8,friction=.145,maxThrust=.0034,maxVSpeed=.68,lifeLooseSpeed=.0125,levelStartDisplayTime=2e3,feltDisplayTime=800,platformAlpha=.85,cityRelativeEnd=.4,cityRelativeHeight=.35,cityRelativeSpeed=.4,timeSpeed=1,hueColors=[0,240],colors=[hsl(hueColors[0],80,55),hsl(hueColors[1],80,55)],RSC={heroSpriteImg:addRsc(Image,"skaterb.png"),level1:addRsc(Image,"level1.png"),level2:addRsc(Image,"level2.png"),level3:addRsc(Image,"level3.png")},InputState=[],keys={LEFT:37,UP:38,UP2:40,RIGHT:39,DOWN:40,SPACE:32},SOUNDS={jump:jsfxr([,,.17,,.17,.36,.17,.24,-.074,,,.06,.65,.26,.28,.49,,,.7,.086,.12,.14,,.5]),landed:jsfxr([,.06,.08,.2,.15,.57,,-.6,-.07,,,.34,,.37,.18,,,,.42,.14,,,,.46]),reversing:jsfxr([1,.1,.3,.13,.4,.28,.06,.1,.053,.3,.4,.1,.2,.9,.08,,,,.76,,,,,.5]),blip:jsfxr([1,,.067,.07,.12,.888,,.012,.02,,,.23,.6,.067,.102,,,.52,1,,,,,.2]),noise:jsfxr([3,.58,.25,.059,-.586,.345,,.0346,-.062,-8e-5,-.61,.91,-.37,.75,.36,-.65,-.6,.019,.23,-.002,-.03,9.9e-8,1.6e-7,.18])},level1={timeToComplete:5e4,heroPosition:{x:2,y:6},dataLoaded:!1,platformPeriod:2800,platforms:null,triggers:[]},level2={timeToComplete:5e4,heroPosition:{x:2,y:5},dataLoaded:!1,platformPeriod:2800,platforms:null,triggers:[]},level3={timeToComplete:8e4,heroPosition:{x:2,y:6},dataLoaded:!1,platformPeriod:2800,platforms:null,triggers:[]},skateSound=null,playingSound=-100;hiscoreScreen={},messageScreen={launch:function(t,e,i,s){this.message1=t,this.message2=e,this.idleTime=i,this.callback=s,this.launchTime=System.systemTime,InputState[keys.SPACE]=!1,System.currentScreen=this},draw:function(){var t=System.systemTime-this.launchTime,e=t/this.idleTime;e>1&&(e=1),erase(),ctx.save(),ctx.globalAlpha=Math.pow(Math.sin(.5*Math.PI*(1-e)),1.3),playScreen.draw(),ctx.restore(),ctx.fillStyle="#99F",sft(44),ctx.fillText(this.message1,W/2,H/2),sft(28),ctx.fillText(this.message2,W/2,H/2+56)},update:function(t){t=System.systemTime-this.launchTime,t>this.idleTime&&InputState[keys.SPACE]&&this.callback()},launchTime:0},playScreen=function(){var t={x:90,y:20,scale:2.05,h:30,colorStops:[0,hsl(30,80,40),1,hsl(60,80,70)],lifeGradient:null,lw:4,strokeStyle:"#A00",ilw:1,istrokeStyle:"#F00",fontSize:28,txtX:48,txtY:35},e={y:t.y+t.h/2,fontSize:50,fillStyle:null},i={platforms:[],stillPlatforms:[],movingPlatforms:[],triggers:[],score:0,launch:function(){this.launchTime=System.systemTime,this.state=0,this.stars=buildStars(25,W,.4*H,1,4),this.hero=new Hero(10,0,heroWidth,heroHeight),this.hero.owner=this,this.camera=new Camera(0,0,W,H);var i=100+(0|100*Math.random());this.buildings=new Building(cityRelativeEnd*H,60,cityRelativeHeight*H,W,i),t.lifeGradient=createGradient([t.x,t.y,100*t.scale,t.h],t.colorStops),e.fillStyle=createGradient([0,e.y-e.fontSize/2,0,e.y+e.fontSize/2],[0,"#FFF",.49,"#FFF",.51,"#000",1,"#000"]),this.setupForLevel(this.currentLevel),0==this.currentLevel&&(this.score=0)},updateScore:function(){this.score+=this.levelScore()},levelScore:function(){return 0|100*this.hero.life+5*(this.levelTime-(System.systemTime-this.playerStartTime))},draw:function(){var t=this.camera;if(fillBG(),drawStars(this.stars),this.mountain.draw(.2*t.x,.01*-t.y),this.buildings.draw(t.x*cityRelativeSpeed),ctx.save(),ctx.translate(-t.x,-t.y),this.hero.drawColor(),this.platforms.forEach(function(e){e.overlaps(t)&&e.draw()}),this.triggers.forEach(function(e){e.draw&&e.overlaps(t)&&e.draw()}),this.hero.draw(),ctx.restore(),this.drawStatus(),0==this.state||2==this.state){var e=0==this.state?this.launchTime:this.fallTime,i=System.systemTime-e;i/=0==this.state?levelStartDisplayTime:feltDisplayTime;var s=Math.pow(Math.sin(i*Math.PI),.7);ctx.fillStyle="#FFF";var a=0==this.state?"LEVEL "+(this.currentLevel+1):"Watch Out !!";ctx.fillText(a,.5*W-40,H*s)}},update:function(t){var e=this.hero;(1==this.state||2==this.state)&&(this.timeLeft=this.levelTime-(System.systemTime-this.playerStartTime),this.timeLeft<=0&&(this.timeLeft=0,messageScreen.launch("Game Over - Caught !! Time out !! -","Score : "+playScreen.score,2e3,function(){System.launchScreen(titleScreen)}))),1==this.state&&(e.handleInput(),(e.y<-4*blockHeight||e.y>this.worldH+4*blockHeight)&&(this.state=2,e.unfalling=System.systemTime,e.restore(),this.fallTime=System.systemTime,e.standStill())),this.platforms.forEach(function(e){e.update(t)}),e.update(t),this.triggers.forEach(function(e){e.update&&e.update(t)}),this.camera.adjust(e,t),0==this.state&&System.systemTime-this.launchTime>levelStartDisplayTime?(this.state=1,this.playerStartTime=System.systemTime):2==this.state&&System.systemTime-this.fallTime>feltDisplayTime&&(this.state=1,e.unfalling=0)},drawStatus:function(){ctx.fillStyle="#F00",sft(t.fontSize),ctx.textBaseline="middle",ctx.fillText("LIFE",t.txtX,t.txtY),ctx.strokeStyle="#000",ctx.lineWidth=1,ctx.strokeText("LIFE",t.txtX,t.txtY),ctx.save(),roundRect(ctx,t.x,t.y,100*t.scale,t.h,8),ctx.save(),ctx.clip(),ctx.fillStyle=t.lifeGradient,ctx.fillRect(t.x,t.y,this.hero.life*t.scale,t.h),ctx.restore(),ctx.strokeStyle=t.strokeStyle,ctx.lineWidth=t.lw,this.hero.losingLife&&Math.floor(Date.now()/200)%2&&(ctx.strokeStyle="#FFF"),ctx.stroke(),ctx.strokeStyle=t.istrokeStyle,ctx.lineWidth=t.ilw,ctx.stroke(),ctx.restore();var i=0|(this.timeLeft+500)/1e3;ctx.font=sft(e.fontSize),ctx.fillStyle=e.fillStyle,ctx.fillText(i,W/2,35),ctx.strokeStyle="#000",ctx.lineWidth=2.5,ctx.strokeText(i,W/2,35)},setupForLevel:function(t){var e=this.hero,i=this.camera;this.currentLevel=t;var s=0,a=levels[t],r=0,n=0;a.dataLoaded||decodeLevel(a,RSC["level"+(t+1)]);var o=a.platforms,l=a.heroPosition;for(e.x=l.x*blockWidth,e.y=l.y*blockHeight,this.platforms.length=0,s=0;s<o.length;s++){var h=o[s];this.platforms.push(new Platform(h[0],h[1],h[2],h[3],h[4],h[5])),r=Math.max(r,h[0]+h[2]),n=Math.max(n,h[1]+h[3])}this.triggers.length=0;var c=this.triggers;a.triggers.forEach(function(t){c.push(t instanceof Trigger?t:new Trigger(t))}),this.state=0,this.worldW=r*blockWidth,this.worldH=n*blockHeight,i.reset(),this.mountain=new Mountain(H/4,H/3,2*W/3,H),this.levelTime=this.timeLeft=a.timeToComplete,gravityDirection=1,e.reset()},launchTime:0,playerStartTime:0,state:0};return i}(),titleScreen=function(){function t(){function t(t){ctx.fillText(t,a,r),r+=i+s}var e="hsl(235, 80%, 80%)",i=18,s=3,a=.5*W,r=.8*H;sft(i),ctx.fillStyle=e,t("The Monochromist party won in Flip red-blue city."),t('"We do not mix colors here", so they say.'),t("Will you, a colorist rebel, escape from flip City in time ??");var n=sinOsc(1,.02),o=System.isMobile?"Touch the screen to play":"Press space to play";i=16,ctx.fillStyle=n>0?"#FFF":"#AAA",sft(i),ctx.fillText(o,a,H-2*i)}function e(){var t=[hsl(235,80,20),hsl(350,80,12)],e=sinOsc(5,.06),i=+(sinOsc(1,.02)>0),s=t[i],a=t[1-i];glowText("ESCAPE",W/2,e+50,50,s),glowText("FROM",W/2,e+110+e/4,30,s),glowText("FLIP CITY",W/2,160+e,50,a),glowText("By GameAlchemist",W/2,210+e,18,a)}var i=-1,s=.1,a=0,r={launch:function(){a=Math.max(+localStorage.hiScore,+playScreen.score),localStorage.hiScore=a,this.launchTime=System.systemTime,i=.65*H,this.stars=buildStars(46,W,.46*H,1,4),this.mountain=new Mountain(H/6,H/2,W,cityRelativeEnd*H+cityRelativeHeight*H+40),this.camera=new Camera(0,0,W,H);var t=100+(0|100*Math.random());this.buildings=new Building(cityRelativeEnd*H,60,cityRelativeHeight*H,W,t),InputState[keys.SPACE]=!1},draw:function(){erase(),drawStars(this.stars);var i=this.camera;this.mountain.draw(.2*i.x,.01*-i.y),this.buildings.draw(i.x*cityRelativeSpeed),e(),t(),ctx.fillText("High Score : "+a,W/2,.7*H)},update:function(t){System.systemTime-this.launchTime>1e3&&InputState[keys.SPACE]&&(playScreen.currentLevel=0,System.launchScreen(playScreen)),this.camera.x+=s*t}};return r}();var levels=[level1,level2,level3],titleScreen,playScreen,hiscoreScreen,messageScreen;